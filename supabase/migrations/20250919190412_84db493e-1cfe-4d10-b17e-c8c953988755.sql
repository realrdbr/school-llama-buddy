-- Fix function search path security issue
-- All SECURITY DEFINER functions should have SET search_path to prevent injection attacks

-- Update existing SECURITY DEFINER functions to have secure search_path
ALTER FUNCTION public.is_current_user_admin_secure() SET search_path = public;
ALTER FUNCTION public.validate_session_security(uuid) SET search_path = public;
ALTER FUNCTION public.log_security_access_attempt() SET search_path = public;
ALTER FUNCTION public.cleanup_expired_sessions() SET search_path = public;
ALTER FUNCTION public.create_user_theme_secure(text, text, text, jsonb) SET search_path = public;
ALTER FUNCTION public.delete_book_session(uuid, text) SET search_path = public;
ALTER FUNCTION public.search_user_directory(text, bigint) SET search_path = public;
ALTER FUNCTION public.update_user_theme_secure(text, text, uuid, jsonb) SET search_path = public;
ALTER FUNCTION public.delete_user_theme_secure(text, text, uuid) SET search_path = public;
ALTER FUNCTION public.is_custom_user_authenticated() SET search_path = public;
ALTER FUNCTION public.create_vertretung_secure(text, text, date, text, smallint, text, text, text, text, text, text, text) SET search_path = public;
ALTER FUNCTION public.update_vertretung_secure(text, text, uuid, text, text, text, text) SET search_path = public;
ALTER FUNCTION public.delete_vertretung_secure(text, text, uuid) SET search_path = public;
ALTER FUNCTION public.add_book_session(text, text, text, text, integer, text, integer, text, text) SET search_path = public;
ALTER FUNCTION public.get_user_contacts(bigint) SET search_path = public;
ALTER FUNCTION public.change_user_password_forced_secure(bigint, text) SET search_path = public;
ALTER FUNCTION public.create_school_user_secure(text, text, text, smallint, bigint, text, boolean) SET search_path = public;
ALTER FUNCTION public.get_user_public_info(bigint) SET search_path = public;
ALTER FUNCTION public.update_book_session(uuid, text, text, text, text, integer, text, integer, text, text) SET search_path = public;
ALTER FUNCTION public.get_current_user_from_session() SET search_path = public;
ALTER FUNCTION public.current_user_has_permission_level(smallint) SET search_path = public;
ALTER FUNCTION public.current_user_owns_resource(bigint) SET search_path = public;
ALTER FUNCTION public.create_user_session(bigint) SET search_path = public;
ALTER FUNCTION public.get_or_create_conversation(bigint) SET search_path = public;
ALTER FUNCTION public.change_user_password_secure(bigint, text, text) SET search_path = public;
ALTER FUNCTION public.create_user_theme_session(text, jsonb) SET search_path = public;
ALTER FUNCTION public.update_user_theme_session(uuid, jsonb) SET search_path = public;
ALTER FUNCTION public.delete_user_theme_session(uuid) SET search_path = public;
ALTER FUNCTION public.mark_messages_as_read(uuid) SET search_path = public;
ALTER FUNCTION public.update_conversation_timestamp() SET search_path = public;
ALTER FUNCTION public.is_current_user_admin() SET search_path = public;
ALTER FUNCTION public.set_session_context(text) SET search_path = public;
ALTER FUNCTION public.invalidate_user_sessions(bigint, uuid) SET search_path = public;
ALTER FUNCTION public.delete_vertretung_session(uuid, text) SET search_path = public;
ALTER FUNCTION public.update_vertretung_session(uuid, text, text, text, text, text) SET search_path = public;
ALTER FUNCTION public.create_vertretung_session(date, text, smallint, text, text, text, text, text, text, text, text) SET search_path = public;
ALTER FUNCTION public.set_primary_session(bigint, uuid) SET search_path = public;
ALTER FUNCTION public.update_session_timestamp() SET search_path = public;
ALTER FUNCTION public.admin_change_user_password(bigint, bigint, text) SET search_path = public;
ALTER FUNCTION public.auto_assign_primary_session(bigint) SET search_path = public;
ALTER FUNCTION public.change_user_password(bigint, text, text) SET search_path = public;
ALTER FUNCTION public.check_brute_force_protection(text, inet) SET search_path = public;
ALTER FUNCTION public.has_active_sessions(bigint) SET search_path = public;
ALTER FUNCTION public.create_school_user(text, text, text, smallint, bigint) SET search_path = public;
ALTER FUNCTION public.check_user_permission(bigint, text) SET search_path = public;
ALTER FUNCTION public.cleanup_old_conversations() SET search_path = public;
ALTER FUNCTION public.create_school_user_secure(text, text, text, smallint, bigint) SET search_path = public;
ALTER FUNCTION public.ensure_single_active_theme() SET search_path = public;
ALTER FUNCTION public.get_current_user_id() SET search_path = public;
ALTER FUNCTION public.get_current_user_permission_level() SET search_path = public;
ALTER FUNCTION public.handle_new_user() SET search_path = public;
ALTER FUNCTION public.hash_password(text) SET search_path = public;
ALTER FUNCTION public.is_current_user_admin_safe() SET search_path = public;
ALTER FUNCTION public.is_session_valid(uuid) SET search_path = public;
ALTER FUNCTION public.log_login_attempt(text, boolean, inet, text) SET search_path = public;
ALTER FUNCTION public.release_primary_session(bigint) SET search_path = public;
ALTER FUNCTION public.update_updated_at_column() SET search_path = public;
ALTER FUNCTION public.rotate_session_token(uuid) SET search_path = public;
ALTER FUNCTION public.session_has_admin_rights(uuid) SET search_path = public;
ALTER FUNCTION public.verify_password(text, text) SET search_path = public;
ALTER FUNCTION public.verify_user_login(text, text) SET search_path = public;
ALTER FUNCTION public.verify_user_login_secure(text, text) SET search_path = public;
ALTER FUNCTION public.verify_user_login_secure(text, text, inet, text) SET search_path = public;